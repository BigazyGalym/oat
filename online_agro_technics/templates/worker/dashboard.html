{% extends 'base.html' %}
{% load static %}
{% block title %}–ü–∞–Ω–µ–ª—å —Ä–∞–±–æ—á–µ–≥–æ{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 animate-fade-in">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
            <img src="{% if profile.avatar %}{{ profile.avatar.url }}{% else %}{% static 'images/default_avatar.jpg' %}{% endif %}" class="w-32 h-32 mx-auto rounded-full shadow-md object-cover">
            <div class="text-center">
                <h2 class="text-xl font-bold">{{ user.username }}</h2>
                <p class="text-gray-500 text-sm">{{ profile.description|default:'–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
                <p class="text-sm">üìû {{ profile.phone_number|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
            </div>
            <div class="flex justify-between text-sm text-gray-700">
                <div><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</strong> {{ profile.completed_orders }}</div>
                <div><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> {{ profile.rating|floatformat:1 }}</div>
            </div>
            <a href="{% url 'accounts:edit_profile' %}" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-2 rounded-lg transition duration-200">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="mt-6">
                <h3 class="text-center text-lg font-semibold text-gray-700">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h3>
                <canvas id="ordersChart" class="mt-4 h-64"></canvas>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –∑–∞–∫–∞–∑—ã -->
        <div class="lg:col-span-2 space-y-6">
            <!-- –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑ -->
            {% if current_order %}
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 class="text-lg font-bold text-blue-600 mb-4">üõ†Ô∏è –¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <p><strong>–£—Å–ª—É–≥–∞:</strong> {{ current_order.service_type.name|default:"-" }}</p>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ current_order.cost|floatformat:2 }} —Ç–≥.</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ current_order.address|default:"-" }}</p>
                    <p><strong>–†–∞–π–æ–Ω:</strong> {{ current_order.district|default:"-" }}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ current_order.get_status_display }}</p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –∑–∞–∫–∞–∑—á–∏–∫–∞:</strong> {{ current_order.customer_id.profile.phone_number }}</p>
                    <p><strong>–®–∏—Ä–æ—Ç–∞:</strong> {{ current_order.latitude }}</p>
                    <p><strong>–î–æ–ª–≥–æ—Ç–∞:</strong> {{ current_order.longitude }}</p>
                    <p><strong>–í—Ä–µ–º—è:</strong> {{ current_order.desired_time|date:"d.m.Y H:i" }}</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ current_order.created_at|date:"d.m.Y H:i" }}</p>
                </div>
                <div id="map" class="h-48 mt-4 rounded-lg border"></div>

                {% if current_order.status == 'accepted' %}
                <form method="post" action="{% url 'orders:start_order' current_order.id %}" class="mt-4">
                    {% csrf_token %}
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                </form>
                {% elif current_order.status == 'in_progress' %}
                <form method="post" action="{% url 'orders:complete_order' current_order.id %}" class="mt-4">
                    {% csrf_token %}
                    <button class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</div>
            {% endif %}

            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã -->
<div class="bg-white p-6 rounded-2xl shadow-md mt-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    </h3>

    {% if available_orders %}
        <div class="space-y-4">
            {% for order in available_orders %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm hover:shadow transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-blue-700">{{ order.get_status_display }}</span>
                        <span class="text-sm text-gray-500">{{ order.cost|floatformat:2 }} —Ç–≥</span>
                    </div>
                    <p class="text-sm"><strong>–£—Å–ª—É–≥–∞:</strong> {{ order.service_type.name|default:"‚Äî" }}</p>
                    <p class="text-sm"><strong>–ê–¥—Ä–µ—Å:</strong> {{ order.address|default:"‚Äî" }}</p>
                    <p class="text-sm"><strong>–†–∞–π–æ–Ω:</strong> {{ order.district|default:"‚Äî" }}</p>
                    <p class="text-sm"><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong> {{ order.customer_id.username|default:"‚Äî" }}</p>
                    <p class="text-sm"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ order.customer_id.profile.phone_number|default:"‚Äî" }}</p>

                    <form method="post" action="{% url 'orders:accept_order' order.id %}" class="mt-3">
                        {% csrf_token %}
                        <button type="submit"
                            class="w-full text-white bg-green-600 hover:bg-green-700 font-semibold py-2 px-4 rounded-lg transition duration-200">
                            –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </form>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- –ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç -->
        <div class="flex items-center justify-center p-6 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
            <p class="text-gray-500 text-sm flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.
            </p>
        </div>
    {% endif %}
</div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
<div class="bg-white p-6 rounded-2xl shadow-md mt-6">
    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center gap-2">
        üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
    </h3>

    {% if completed_orders %}
        <div class="space-y-4">
            {% for order in completed_orders %}
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm hover:shadow transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-green-700">‚úÖ {{ order.get_status_display }}</span>
                        <span class="text-sm text-gray-500">
                            –û—Ü–µ–Ω–∫–∞: 
                            {% if order.rating %}
                                <strong>{{ order.rating }}</strong>
                            {% else %}
                                <em class="text-red-500">–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ</em>
                            {% endif %}
                        </span>
                    </div>
                    <p class="text-sm"><strong>–£—Å–ª—É–≥–∞:</strong> {{ order.service_type.name|default:"‚Äî" }}</p>
                    <p class="text-sm"><strong>–ê–¥—Ä–µ—Å:</strong> {{ order.address|default:"‚Äî" }}</p>
                    <p class="text-sm text-gray-500">
                        <strong>–î–∞—Ç–∞:</strong> 
                        {{ order.completed_at|date:"d.m.Y H:i"|default:"‚Äî" }}
                    </p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 italic">–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>
    {% endif %}
</div>

            

<!-- Chart.js –∏ –∫–∞—Ä—Ç–∞ -->
<script>
const ctx = document.getElementById('ordersChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['–î–æ—Å—Ç—É–ø–Ω–æ', '–ü—Ä–∏–Ω—è—Ç–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'],
        datasets: [{
            data: [
                {{ order_stats.available|default:0 }},
                {{ order_stats.accepted|default:0 }},
                {{ order_stats.in_progress|default:0 }},
                {{ order_stats.completed|default:0 }}
            ],
            backgroundColor: ['#f87171', '#60a5fa', '#fbbf24', '#34d399'],
            hoverOffset: 6
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}
